@(implicit request: Request[Any], environment: play.api.Environment)

@main("forgot password?",None,"forgot passord?",false) {
} {
} {

<div id="title-container">
  <h2>Forgot Password?</h2>
</div>
<div id="primary-container" class="forgot-password-page">
  <div class="content">
    <div class="message-container"></div>

    <div class="forgot-password-container"></div>

    <div class="clearing">&nbsp;</div>
  </div>
</div>


<script type="text/html" id="forgot-password-template">

<div class="email-address-container">
  <label>Email Address:</label>
  <input id="email-address-input" type="text" data-bind="value:email,events:['keyup']">
  <div class="clearing">&nbsp;</div>
</div>
<div class="send-reset-password-link-button-container">
  <label>&nbsp;</label>
  <a class="button send-reset-password-link-button button-default" style="float:left;">send reset password link</a>
  <img class="send-reset-password-link-wait-img" src='@routes.Assets.versioned("/public/images","ajax-spinner-transparent.gif")' style="display:none;float:left;margin-left:5px;" />
  <div class="clearing">&nbsp;</div>
</div>
<div class="clearing">&nbsp;</div>

</script>

<script type="text/html" id="wait-template">

<img id="wait-img" src='@routes.Assets.versioned("/public/images","ajax-spinner-transparent.gif")' />

</script>

<script type="text/html" id="unexpected-error-template">

<div class="error-box">There was an unexpected error.  Try again later.</div>

</script>

<script type="text/html" id="bad-request-error-template">

<div class="error-box"><%= message %>&nbsp;&nbsp;Try again.</div>

</script>

<script type="text/javascript">

  var com;
  $(function(){
    @views.html.components.namespace_init(Seq("home"))
    @views.html.components.epoxy_init()
    com.rodneylai.home.forgot_password = function() {
      var m_app;

      return {
        init: function() {
          m_app = new Backbone.Marionette.Application();

          m_app.module('model', function (model, app, Backbone) {

            model.ForgotPassword = Backbone.Model.extend({
              defaults: {
                email : ""
              },
              url: '@controllers.services.routes.auth.sendResetPasswordLink'
            });

            model.BadRequest = Backbone.Model.extend({
              defaults: {
                message : ""
              }
            });

          });

          m_app.module('view', function (view, app, Backbone, Marionette) {

            view.ForgotPassword = com.rodneylai.EpoxyItemView.extend({
              model: app.model.ForgotPassword,
              bindings: "data-bind",
              template: Backbone.Marionette.TemplateCache.get("#forgot-password-template"),
              ui: {
                email_address_input:"#email-address-input",
                send_reset_password_link_button:".send-reset-password-link-button",
                send_reset_password_link_wait_img:".send-reset-password-link-wait-img"
              },
              events: {
                "click .send-reset-password-link-button[disabled!=disabled]" : "send_reset_password_link_click",
                "keyup #email-address-input" : "check_for_enter"
              },
              check_for_enter:function(ev){
                if (ev.keyCode == 13) {
                  this.send_reset_password_link_click();
                }
              },
              send_reset_password_link_click:function(){
                var view = this;

                this.ui.send_reset_password_link_wait_img.show();
                this.ui.email_address_input.attr("disabled","disabled");
                this.ui.send_reset_password_link_button.attr("disabled","disabled");
                this.model.save(null,
                  {
                    success: function(model, response, options){
                      if (response == 'fail') {
                        m_app.message.show(new m_app.view.UnexpectedError());
                      } else {
@request.queryString.get("return_url") match {
  case Some(returnUrl) => {
                        document.location = '@returnUrl';
  }
  case None => {
                        document.location = response;
  }
}
                      }
                    },
                    error: function(model, xhr, options){
                      view.ui.email_address_input.removeAttr("disabled");
                      view.ui.send_reset_password_link_button.removeAttr("disabled");
                      view.ui.send_reset_password_link_wait_img.hide();
                      if ((xhr.status == 400) && (xhr.responseText)) {
                        m_app.message.show(new m_app.view.BadRequestError({ model : new m_app.model.BadRequest({"message":xhr.responseText}) }));
                      } else {
                        m_app.message.show(new m_app.view.UnexpectedError());
                      }
                    }
                  }
                );
              }
            });

            view.UnexpectedError = Marionette.ItemView.extend({
              model: app.model.BadRequest,
              template: Backbone.Marionette.TemplateCache.get("#unexpected-error-template"),
              ui: {
                error_box:".error-box"
              },
              onShow: function(){
                var ui = this.ui;
                setInterval(function(){$(ui.error_box).fadeOut()},5000);
              }
            });

            view.BadRequestError = Marionette.ItemView.extend({
              template: Backbone.Marionette.TemplateCache.get("#bad-request-error-template"),
              ui: {
                error_box:".error-box"
              },
              onShow: function(){
                var ui = this.ui;
                setInterval(function(){$(ui.error_box).fadeOut()},5000);
              }
            });

            view.Wait = Marionette.ItemView.extend({
              template: Backbone.Marionette.TemplateCache.get("#wait-template")
            });

          });

          m_app.addRegions({message : '.message-container',
                            forgot_password : '.forgot-password-container'
          });

          m_app.addInitializer(function(options){
            m_app.forgot_password.show(new m_app.view.ForgotPassword({ model : new m_app.model.ForgotPassword() }));
          });

          m_app.start();
        }
      }
    }();
    com.rodneylai.home.forgot_password.init();
  });

</script>

}

@*
 *
 * Copyright (c) 2015-2016 Rodney S.K. Lai
 * https://github.com/rodney-lai
 *
 * Permission to use, copy, modify, and/or distribute this software for
 * any purpose with or without fee is hereby granted, provided that the
 * above copyright notice and this permission notice appear in all copies.
 *
 * THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
 * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
 * ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
 * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
 * ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
 * OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.
 *
 *@
